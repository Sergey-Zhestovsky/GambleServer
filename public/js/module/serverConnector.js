"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _tableController=_interopRequireDefault(require("/js/module/tableController.js")),_connector=_interopRequireDefault(require("/js/module/connector.js"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _get(t,e,r){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var n=_superPropBase(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(r):o.value}})(t,e,r||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var ServerConnector=function(t){function c(t){var e,r=t.path,n=t.tableConfig,o=t.actions,i=void 0===o?{}:o,a=t.relatedData,s=t.signRequests,l=t.customEvents,u=void 0===l?{}:l;return _classCallCheck(this,c),(e=_possibleConstructorReturn(this,_getPrototypeOf(c).call(this,{signRequests:s}))).path=r,e.tableConfig=n,e.actions=i,e.relatedData=a,e.customEvents=u,e.table,e.eventList=new Map,e.create(),e}return _inherits(c,_connector.default),_createClass(c,[{key:"create",value:function(){var l=this;if(this.actions.get){var t=[this.actionRequest("get",{length:this.tableConfig.selector.dataStep[0],padding:0})];this.relatedData&&this.getRelatedData(this.relatedData,t),Promise.all(t).then(function(t){if(l.relatedData){var e=1,r=!0,n=!1,o=void 0;try{for(var i,a=l.relatedData[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var s=i.value;l.tableConfig[s.to].relatedData||(l.tableConfig[s.to].relatedData=[],l.tableConfig[s.to].relatedData[s.name]=s.storeVariable?t[e++][s.storeVariable]:t[e++])}}catch(t){n=!0,o=t}finally{try{r||null==a.return||a.return()}finally{if(n)throw o}}}l.connectToTableController(t[0])}).catch(function(t){console.error(new Error("ServerConnector"),t)})}}},{key:"getRelatedData",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],r=!0,n=!1,o=void 0;try{for(var i,a=t[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var s=i.value;e.push(this.request(s.path,s.options))}}catch(t){n=!0,o=t}finally{try{r||null==a.return||a.return()}finally{if(n)throw o}}return e}},{key:"connectToTableController",value:function(t){this.tableConfig=Object.assign(this.tableConfig,t),(this.tableConfig.connector=this).table=new _tableController.default(this.tableConfig),this.setTableListners()}},{key:"setTableListners",value:function(){for(var t=["get","add","edit","delete"],e=0;e<t.length;e++){var r=t[e];this.actions[r]&&this.tableDataListner(r,this.actionRequest.bind(this,r))}}},{key:"actionRequest",value:function(t,e){return this.request(this.path+this.actions[t].path,e)}},{key:"customEventRequest",value:function(t,e,r){if(!this.customEvents[t])return r("wrong path");var n=this.cancelableRequest(this.path+this.customEvents[t],e);return n.request.then(function(t){r(null,t)}).catch(function(t){r(t)}),n}},{key:"request",value:function(t,e){return _get(_getPrototypeOf(c.prototype),"straightRequest",this).call(this,t,e)}},{key:"cancelableRequest",value:function(t,e){return _get(_getPrototypeOf(c.prototype),"request",this).call(this,t,e)}},{key:"tableDataListner",value:function(r,n){var o=this;this.table.on(r,function(t,e){n(t).then(function(t){o.triggerEvent(r),e(null,t)}).catch(function(t){console.error(t),e(t)})})}},{key:"triggerEvent",value:function(t){if(this.eventList.has(t)){var e=!0,r=!1,n=void 0;try{for(var o,i=this.eventList.get(t)[Symbol.iterator]();!(e=(o=i.next()).done);e=!0){(0,o.value)()}}catch(t){r=!0,n=t}finally{try{e||null==i.return||i.return()}finally{if(r)throw n}}}}},{key:"on",value:function(t,e){this.eventList.has(t)?this.eventList.get(t).push(e):this.eventList.set(t,[e])}},{key:"of",value:function(t,e){if(this.eventList.has(t))for(var r=this.eventList.get(t),n=0;n<r.length;n++)r[n]===e&&r.splice(n--,1)}}]),c}();exports.default=ServerConnector;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL21vZHVsZS9zZXJ2ZXJDb25uZWN0b3IuanMiXSwibmFtZXMiOlsiX3RhYmxlQ29udHJvbGxlciIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX2Nvbm5lY3RvciIsIlNlcnZlckNvbm5lY3RvciIsIl9yZWYiLCJfdGhpcyIsInBhdGgiLCJ0YWJsZUNvbmZpZyIsIl9yZWYkYWN0aW9ucyIsImFjdGlvbnMiLCJyZWxhdGVkRGF0YSIsInNpZ25SZXF1ZXN0cyIsIl9yZWYkY3VzdG9tRXZlbnRzIiwiY3VzdG9tRXZlbnRzIiwiX2NsYXNzQ2FsbENoZWNrIiwidGhpcyIsIl9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIiwiX2dldFByb3RvdHlwZU9mIiwiY2FsbCIsInRhYmxlIiwiZXZlbnRMaXN0IiwiTWFwIiwiY3JlYXRlIiwiQ29ubmVjdG9yIiwiX3RoaXMyIiwiZ2V0IiwicHJvbWlzZUFycmF5IiwiYWN0aW9uUmVxdWVzdCIsImxlbmd0aCIsInNlbGVjdG9yIiwiZGF0YVN0ZXAiLCJwYWRkaW5nIiwiZ2V0UmVsYXRlZERhdGEiLCJQcm9taXNlIiwiYWxsIiwidGhlbiIsImFsbFJlc3VsdHMiLCJpIiwiX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbiIsIl9kaWRJdGVyYXRvckVycm9yIiwiX2l0ZXJhdG9yRXJyb3IiLCJ1bmRlZmluZWQiLCJfc3RlcCIsIl9pdGVyYXRvciIsIlN5bWJvbCIsIml0ZXJhdG9yIiwibmV4dCIsImRvbmUiLCJkYXRhIiwidmFsdWUiLCJ0byIsIm5hbWUiLCJzdG9yZVZhcmlhYmxlIiwiZXJyIiwicmV0dXJuIiwiY2F0Y2giLCJlIiwiY29uc29sZSIsImVycm9yIiwiRXJyb3IiLCJyZXN1bHQiLCJhcmd1bWVudHMiLCJfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMiIsIl9kaWRJdGVyYXRvckVycm9yMiIsIl9pdGVyYXRvckVycm9yMiIsIl9zdGVwMiIsIl9pdGVyYXRvcjIiLCJkYXRhQXJyYXkiLCJwdXNoIiwicmVxdWVzdCIsIm9wdGlvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJfaSIsImFjdGlvbiIsInRhYmxlRGF0YUxpc3RuZXIiLCJiaW5kIiwib2JqZWN0IiwiZXZlbnROYW1lIiwiY2IiLCJyZXF1ZXN0T2JqY2V0IiwiY2FuY2VsYWJsZVJlcXVlc3QiLCJfZ2V0IiwicHJvdG90eXBlIiwiaGFuZGxlciIsIl90aGlzMyIsIm9uIiwidHJpZ2dlckV2ZW50IiwiZXZlbnQiLCJoYXMiLCJfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uMyIsIl9kaWRJdGVyYXRvckVycm9yMyIsIl9pdGVyYXRvckVycm9yMyIsIl9zdGVwMyIsIl9pdGVyYXRvcjMiLCJmIiwiZnVuYyIsInNldCIsImFyciIsInNwbGljZSJdLCJtYXBwaW5ncyI6IkFBQUEsMkZBRUEsSUFBQUEsaUJBQUFDLHVCQUFBQyxRQUFBLGtDQUNBQyxXQUFBRix1QkFBQUMsUUFBQSxpMURBRXFCRSw0QkFDakIsU0FBQUEsRUFBQUMsR0FBK0YsSUFBQUMsRUFBakZDLEVBQWlGRixFQUFqRkUsS0FBTUMsRUFBMkVILEVBQTNFRyxZQUEyRUMsRUFBQUosRUFBOURLLFFBQUFBLE9BQThELElBQUFELEVBQXBELEdBQW9EQSxFQUFoREUsRUFBZ0ROLEVBQWhETSxZQUFhQyxFQUFtQ1AsRUFBbkNPLGFBQW1DQyxFQUFBUixFQUFyQlMsYUFBQUEsT0FBcUIsSUFBQUQsRUFBTixHQUFNQSxFQUFBLE9BQUFFLGdCQUFBQyxLQUFBWixJQUpuR0UsRUFBQVcsMkJBQUFELEtBQUFFLGdCQUFBZCxHQUFBZSxLQUFBSCxLQUFBLENBQUFKLGFBQUFBLE1BQ0FMLEtBQUFBLEVBT1FELEVBQUtFLFlBQWNBLEVBQ25CRixFQUFLSSxRQUFVQSxFQUNmSixFQUFLSyxZQUFjQSxFQUNuQkwsRUFBS1EsYUFBZUEsRUFFcEJSLEVBQUtjLE1BQ0xkLEVBQUtlLFVBQVksSUFBSUMsSUFFckJoQixFQUFLaUIsU0Fac0ZqQixxQkFEdERrQixXQUFBQSx3REFnQmhDLElBQUFDLEVBQUFULEtB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QUErRCxHQUFBbkQsRUFBQSxFQUFBQSxFQUFBNkQsRUFBQXRFLE9BQUFTLElBQUE2RCxFQUFBN0QsS0FBQTJELEdBQUFFLEVBQUFDLE9BQUE5RCxJQUFBIiwiZmlsZSI6ImpzL21vZHVsZS9zZXJ2ZXJDb25uZWN0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5pbXBvcnQgVGFibGVDb250cm9sbGVyIGZyb20gJy9qcy9tb2R1bGUvdGFibGVDb250cm9sbGVyLmpzJztcclxuaW1wb3J0IENvbm5lY3RvciBmcm9tICcvanMvbW9kdWxlL2Nvbm5lY3Rvci5qcyc7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTZXJ2ZXJDb25uZWN0b3IgZXh0ZW5kcyBDb25uZWN0b3Ige1xyXG4gICAgY29uc3RydWN0b3IoeyBwYXRoLCB0YWJsZUNvbmZpZywgYWN0aW9ucyA9IHt9LCByZWxhdGVkRGF0YSwgc2lnblJlcXVlc3RzLCBjdXN0b21FdmVudHMgPSB7fSB9KSB7XHJcbiAgICAgICAgc3VwZXIoe3NpZ25SZXF1ZXN0c30pO1xyXG5cclxuICAgICAgICB0aGlzLnBhdGggPSBwYXRoO1xyXG4gICAgICAgIHRoaXMudGFibGVDb25maWcgPSB0YWJsZUNvbmZpZztcclxuICAgICAgICB0aGlzLmFjdGlvbnMgPSBhY3Rpb25zO1xyXG4gICAgICAgIHRoaXMucmVsYXRlZERhdGEgPSByZWxhdGVkRGF0YTtcclxuICAgICAgICB0aGlzLmN1c3RvbUV2ZW50cyA9IGN1c3RvbUV2ZW50cztcclxuICAgICAgICBcclxuICAgICAgICB0aGlzLnRhYmxlO1xyXG4gICAgICAgIHRoaXMuZXZlbnRMaXN0ID0gbmV3IE1hcCgpO1xyXG5cclxuICAgICAgICB0aGlzLmNyZWF0ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZSgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuYWN0aW9ucy5nZXQpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgbGV0IHByb21pc2VBcnJheSA9IFt0aGlzLmFjdGlvblJlcXVlc3QoXCJnZXRcIiwgeyBsZW5ndGg6IHRoaXMudGFibGVDb25maWcuc2VsZWN0b3IuZGF0YVN0ZXBbMF0sIHBhZGRpbmc6IDAgfSldO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5yZWxhdGVkRGF0YSkgXHJcbiAgICAgICAgICAgIHRoaXMuZ2V0UmVsYXRlZERhdGEodGhpcy5yZWxhdGVkRGF0YSwgcHJvbWlzZUFycmF5KTtcclxuXHJcbiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZUFycmF5KVxyXG4gICAgICAgICAgICAudGhlbigoIGFsbFJlc3VsdHMgKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5yZWxhdGVkRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBpID0gMTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBkYXRhIG9mIHRoaXMucmVsYXRlZERhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJsZUNvbmZpZ1tkYXRhLnRvXS5yZWxhdGVkRGF0YSB8fCAodGhpcy50YWJsZUNvbmZpZ1tkYXRhLnRvXS5yZWxhdGVkRGF0YSA9IFtdKSAmJiBcclxuICAgICAgICAgICAgICAgICAgICAgICAgKHRoaXMudGFibGVDb25maWdbZGF0YS50b10ucmVsYXRlZERhdGFbZGF0YS5uYW1lXSA9IGRhdGEuc3RvcmVWYXJpYWJsZSBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYWxsUmVzdWx0c1tpKytdW2RhdGEuc3RvcmVWYXJpYWJsZV0gXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGFsbFJlc3VsdHNbaSsrXSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5jb25uZWN0VG9UYWJsZUNvbnRyb2xsZXIoYWxsUmVzdWx0c1swXSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihuZXcgRXJyb3IoXCJTZXJ2ZXJDb25uZWN0b3JcIiksIGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRSZWxhdGVkRGF0YShkYXRhQXJyYXksIHJlc3VsdCA9IFtdKSB7XHJcbiAgICAgICAgZm9yKGxldCBkYXRhIG9mIGRhdGFBcnJheSkge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh0aGlzLnJlcXVlc3QoZGF0YS5wYXRoLCBkYXRhLm9wdGlvbnMpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgY29ubmVjdFRvVGFibGVDb250cm9sbGVyKGRhdGEpIHtcclxuICAgICAgICB0aGlzLnRhYmxlQ29uZmlnID0gT2JqZWN0LmFzc2lnbih0aGlzLnRhYmxlQ29uZmlnLCBkYXRhKTtcclxuICAgICAgICB0aGlzLnRhYmxlQ29uZmlnLmNvbm5lY3RvciA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy50YWJsZSA9IG5ldyBUYWJsZUNvbnRyb2xsZXIodGhpcy50YWJsZUNvbmZpZyk7XHJcbiAgICAgICAgdGhpcy5zZXRUYWJsZUxpc3RuZXJzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0VGFibGVMaXN0bmVycygpIHtcclxuICAgICAgICBjb25zdCBhY3Rpb25zID0gW1wiZ2V0XCIsIFwiYWRkXCIsIFwiZWRpdFwiLCBcImRlbGV0ZVwiXTtcclxuXHJcbiAgICAgICAgZm9yKGxldCBhY3Rpb24gb2YgYWN0aW9ucykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5hY3Rpb25zW2FjdGlvbl0pXHJcbiAgICAgICAgICAgICAgICB0aGlzLnRhYmxlRGF0YUxpc3RuZXIoYWN0aW9uLCB0aGlzLmFjdGlvblJlcXVlc3QuYmluZCh0aGlzLCBhY3Rpb24pKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYWN0aW9uUmVxdWVzdChhY3Rpb24sIG9iamVjdCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QodGhpcy5wYXRoICsgdGhpcy5hY3Rpb25zW2FjdGlvbl0ucGF0aCwgb2JqZWN0KTtcclxuICAgIH1cclxuXHJcbiAgICBjdXN0b21FdmVudFJlcXVlc3QoZXZlbnROYW1lLCBvYmplY3QsIGNiKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmN1c3RvbUV2ZW50c1tldmVudE5hbWVdKVxyXG4gICAgICAgICAgICByZXR1cm4gY2IoXCJ3cm9uZyBwYXRoXCIpO1xyXG5cclxuICAgICAgICBsZXQgcmVxdWVzdE9iamNldCA9IHRoaXMuY2FuY2VsYWJsZVJlcXVlc3QodGhpcy5wYXRoICsgdGhpcy5jdXN0b21FdmVudHNbZXZlbnROYW1lXSwgb2JqZWN0KTtcclxuXHJcbiAgICAgICAgcmVxdWVzdE9iamNldC5yZXF1ZXN0XHJcbiAgICAgICAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgIGNiKG51bGwsIHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIGNiKGVycm9yKVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlcXVlc3RPYmpjZXQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmVxdWVzdChwYXRoLCBvYmplY3QpIHtcclxuICAgICAgICByZXR1cm4gc3VwZXIuc3RyYWlnaHRSZXF1ZXN0KHBhdGgsIG9iamVjdCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2FuY2VsYWJsZVJlcXVlc3QocGF0aCwgb2JqZWN0KSB7XHJcbiAgICAgICAgcmV0dXJuIHN1cGVyLnJlcXVlc3QocGF0aCwgb2JqZWN0KTtcclxuICAgIH1cclxuXHJcbiAgICB0YWJsZURhdGFMaXN0bmVyKGV2ZW50TmFtZSwgaGFuZGxlcikge1xyXG4gICAgICAgIHRoaXMudGFibGUub24oZXZlbnROYW1lLCAob2JqZWN0LCBjYikgPT4ge1xyXG4gICAgICAgICAgICBoYW5kbGVyKG9iamVjdClcclxuICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJFdmVudChldmVudE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKCAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKVxyXG4gICAgICAgICAgICAgICAgICAgIGNiKGVycm9yKVxyXG4gICAgICAgICAgICAgICAgfSApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRyaWdnZXJFdmVudChldmVudCkge1xyXG4gICAgICAgIGlmICh0aGlzLmV2ZW50TGlzdC5oYXMoZXZlbnQpKSBcclxuICAgICAgICAgICAgZm9yKGxldCBmIG9mIHRoaXMuZXZlbnRMaXN0LmdldChldmVudCkpXHJcbiAgICAgICAgICAgICAgICBmKCk7XHJcbiAgICB9XHJcblxyXG4gICAgb24oZXZlbnQsIGZ1bmMpIHtcclxuICAgICAgICBpZiAodGhpcy5ldmVudExpc3QuaGFzKGV2ZW50KSlcclxuICAgICAgICAgICAgdGhpcy5ldmVudExpc3QuZ2V0KGV2ZW50KS5wdXNoKGZ1bmMpXHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICB0aGlzLmV2ZW50TGlzdC5zZXQoZXZlbnQsIFtmdW5jXSkgXHJcbiAgICB9XHJcblxyXG4gICAgb2YoZXZlbnQsIGZ1bmMpIHtcclxuICAgICAgICBpZiAodGhpcy5ldmVudExpc3QuaGFzKGV2ZW50KSkge1xyXG4gICAgICAgICAgICBsZXQgYXJyID0gdGhpcy5ldmVudExpc3QuZ2V0KGV2ZW50KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmIChhcnJbaV0gPT09IGZ1bmMpIFxyXG4gICAgICAgICAgICAgICAgICAgIGFyci5zcGxpY2UoaS0tLCAxKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19
